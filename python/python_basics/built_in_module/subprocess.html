<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.26">
    <title>Subprocess | Xiaoteng Notebook</title><meta name="description" content="Just playing around">
    <link rel="preload" href="/assets/js/runtime~app.c5a372b8.js" as="script"><link rel="preload" href="/assets/css/styles.cdce1c03.css" as="style"><link rel="preload" href="/assets/js/8690.2c4ac00b.js" as="script"><link rel="preload" href="/assets/js/app.6ff1040a.js" as="script">
    <link rel="stylesheet" href="/assets/css/styles.cdce1c03.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/" class=""><img class="logo" src="/lion.jpeg" alt="Xiaoteng Notebook"><span class="site-name can-hide">Xiaoteng Notebook</span></a></span><div class="navbar-links-wrapper" style=""><!--[--><!--]--><nav class="navbar-links can-hide"><!--[--><div class="navbar-links-item"><a href="/" class="nav-link" aria-label="首页"><!--[--><!--]--> 首页 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/python/" class="nav-link router-link-active" aria-label="Python"><!--[--><!--]--> Python <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/vuepress/" class="nav-link" aria-label="Vuepress"><!--[--><!--]--> Vuepress <!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-dark-button" title="toggle dark mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-links"><!--[--><div class="navbar-links-item"><a href="/" class="nav-link" aria-label="首页"><!--[--><!--]--> 首页 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/python/" class="nav-link router-link-active" aria-label="Python"><!--[--><!--]--> Python <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/vuepress/" class="nav-link" aria-label="Vuepress"><!--[--><!--]--> Vuepress <!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-links"><!--[--><!--[--><a href="/python/" class="nav-link router-link-active sidebar-heading sidebar-item" aria-label="Python"><!--[--><!--]--> Python <!--[--><!--]--></a><!----><!--]--><!--[--><a href="/python/python_basics" class="nav-link router-link-active sidebar-heading sidebar-item active" aria-label="Python basic"><!--[--><!--]--> Python basic <!--[--><!--]--></a><ul class=""><li><!--[--><a href="/python/python_basics/decorators.md" class="nav-link sidebar-item" aria-label="Decorators 装饰器"><!--[--><!--]--> Decorators 装饰器 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_basics/metaclasses.md" class="nav-link sidebar-item" aria-label="Metaclasses"><!--[--><!--]--> Metaclasses <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_basics/slice.md" class="nav-link sidebar-item" aria-label="Slice 切片"><!--[--><!--]--> Slice 切片 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_basics/tips.md" class="nav-link sidebar-item" aria-label="Tips"><!--[--><!--]--> Tips <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_basics/unittest.md" class="nav-link sidebar-item" aria-label="Unittest"><!--[--><!--]--> Unittest <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_basics/built_in_module" class="nav-link router-link-active sidebar-item active" aria-label="内置模块"><!--[--><!--]--> 内置模块 <!--[--><!--]--></a><ul class="sidebar-sub-items"><li><!--[--><a href="/python/python_basics/built_in_module/base64.md" class="nav-link sidebar-item" aria-label="Base64"><!--[--><!--]--> Base64 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_basics/built_in_module/csv-model.md" class="nav-link sidebar-item" aria-label="Csv 模块"><!--[--><!--]--> Csv 模块 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_basics/built_in_module/datetime.md" class="nav-link sidebar-item" aria-label="Datetime time"><!--[--><!--]--> Datetime time <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_basics/built_in_module/html.md" class="nav-link sidebar-item" aria-label="Html 实体"><!--[--><!--]--> Html 实体 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_basics/built_in_module/json.md" class="nav-link sidebar-item" aria-label="Json格式"><!--[--><!--]--> Json格式 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_basics/built_in_module/multiprocessing.md" class="nav-link sidebar-item" aria-label="Multiprocessing"><!--[--><!--]--> Multiprocessing <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_basics/built_in_module/os-model.md" class="nav-link sidebar-item" aria-label="Os model"><!--[--><!--]--> Os model <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_basics/built_in_module/logging.md" class="nav-link sidebar-item" aria-label="Python logging"><!--[--><!--]--> Python logging <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_basics/built_in_module/random.md" class="nav-link sidebar-item" aria-label="Random"><!--[--><!--]--> Random <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_basics/built_in_module/string.md" class="nav-link sidebar-item" aria-label="String 模块"><!--[--><!--]--> String 模块 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_basics/built_in_module/subprocess.md" class="nav-link sidebar-item active" aria-label="Subprocess"><!--[--><!--]--> Subprocess <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_basics/built_in_module/sys.md" class="nav-link sidebar-item" aria-label="Sys"><!--[--><!--]--> Sys <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_basics/built_in_module/time.md" class="nav-link sidebar-item" aria-label="Time 模块"><!--[--><!--]--> Time 模块 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_basics/built_in_module/urllib.md" class="nav-link sidebar-item" aria-label="Urllib"><!--[--><!--]--> Urllib <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_basics/built_in_module/re-model.md" class="nav-link sidebar-item" aria-label="正则表达式"><!--[--><!--]--> 正则表达式 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><a href="/python/python_basics/install.md" class="nav-link sidebar-item" aria-label="安装"><!--[--><!--]--> 安装 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_basics/exception.md" class="nav-link sidebar-item" aria-label="异常处理 exception"><!--[--><!--]--> 异常处理 exception <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_basics/data_structure.md" class="nav-link sidebar-item" aria-label="数据结构"><!--[--><!--]--> 数据结构 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_basics/modules" class="nav-link sidebar-item" aria-label="模块"><!--[--><!--]--> 模块 <!--[--><!--]--></a><ul class="sidebar-sub-items"><li><!--[--><a href="/python/python_basics/modules/apscheduler.md" class="nav-link sidebar-item" aria-label="Apscheduler"><!--[--><!--]--> Apscheduler <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_basics/modules/brotli.md" class="nav-link sidebar-item" aria-label="Brotli"><!--[--><!--]--> Brotli <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_basics/modules/httpx.md" class="nav-link sidebar-item" aria-label="Httpx"><!--[--><!--]--> Httpx <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_basics/modules/matplotlib.md" class="nav-link sidebar-item" aria-label="Matplotlib"><!--[--><!--]--> Matplotlib <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_basics/modules/paramiko.md" class="nav-link sidebar-item" aria-label="Paramiko 模块"><!--[--><!--]--> Paramiko 模块 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_basics/modules/pycryptodome.md" class="nav-link sidebar-item" aria-label="Pycryptodome 模块"><!--[--><!--]--> Pycryptodome 模块 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_basics/modules/pyexecjs.md" class="nav-link sidebar-item" aria-label="Pyexecjs python执行js代码"><!--[--><!--]--> Pyexecjs python执行js代码 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_basics/modules/pytesseract.md" class="nav-link sidebar-item" aria-label="Tesserocr ocr图片识别文字"><!--[--><!--]--> Tesserocr ocr图片识别文字 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_basics/modules/tesserocr.md" class="nav-link sidebar-item" aria-label="Tesserocr ocr图片识别文字"><!--[--><!--]--> Tesserocr ocr图片识别文字 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><a href="/python/python_basics/encode.md" class="nav-link sidebar-item" aria-label="编码问题"><!--[--><!--]--> 编码问题 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_basics/process_thread_coroutine.md" class="nav-link sidebar-item" aria-label="进程 线程 和 协程"><!--[--><!--]--> 进程 线程 和 协程 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_basics/iteration_generator_iterable.md" class="nav-link sidebar-item" aria-label="迭代器 生成器 可迭代对象"><!--[--><!--]--> 迭代器 生成器 可迭代对象 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--><!--[--><a href="/python/python_web" class="nav-link sidebar-heading sidebar-item" aria-label="Python web"><!--[--><!--]--> Python web <!--[--><!--]--></a><ul class=""><li><!--[--><a href="/python/python_web/ajax.md" class="nav-link sidebar-item" aria-label="Ajax"><!--[--><!--]--> Ajax <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_web/celery" class="nav-link sidebar-item" aria-label="Celery"><!--[--><!--]--> Celery <!--[--><!--]--></a><ul class="sidebar-sub-items"><li><!--[--><a href="/python/python_web/celery/index.md" class="nav-link sidebar-item" aria-label="Celery"><!--[--><!--]--> Celery <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><a href="/python/python_web/django" class="nav-link sidebar-item" aria-label="Django"><!--[--><!--]--> Django <!--[--><!--]--></a><ul class="sidebar-sub-items"><li><!--[--><a href="/python/python_web/django/django_admin.md" class="nav-link sidebar-item" aria-label="Admin"><!--[--><!--]--> Admin <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_web/django/apps.md" class="nav-link sidebar-item" aria-label="Apps"><!--[--><!--]--> Apps <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_web/django/models.md" class="nav-link sidebar-item" aria-label="Models.py"><!--[--><!--]--> Models.py <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_web/django/more.md" class="nav-link sidebar-item" aria-label="More"><!--[--><!--]--> More <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_web/django/settings.md" class="nav-link sidebar-item" aria-label="Setting.py"><!--[--><!--]--> Setting.py <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_web/django/templates.md" class="nav-link sidebar-item" aria-label="Templates 模板"><!--[--><!--]--> Templates 模板 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_web/django/HTTP.md" class="nav-link sidebar-item" aria-label="Url"><!--[--><!--]--> Url <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_web/django/urls.md" class="nav-link sidebar-item" aria-label="Urls"><!--[--><!--]--> Urls <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_web/django/views.md" class="nav-link sidebar-item" aria-label="Views"><!--[--><!--]--> Views <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_web/django/django_start_up.md" class="nav-link sidebar-item" aria-label="开始一个项目"><!--[--><!--]--> 开始一个项目 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_web/django/static_files.md" class="nav-link sidebar-item" aria-label="静态文件"><!--[--><!--]--> 静态文件 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><a href="/python/python_web/flask" class="nav-link sidebar-item" aria-label="Flask"><!--[--><!--]--> Flask <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_web/http" class="nav-link sidebar-item" aria-label="Http 协议"><!--[--><!--]--> Http 协议 <!--[--><!--]--></a><ul class="sidebar-sub-items"><li><!--[--><a href="/python/python_web/http/post.md" class="nav-link sidebar-item" aria-label="Post"><!--[--><!--]--> Post <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><a href="/python/python_web/jinja.md" class="nav-link sidebar-item" aria-label="Jinja"><!--[--><!--]--> Jinja <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_web/python_wsgi.md" class="nav-link sidebar-item" aria-label="Python 应用服务器"><!--[--><!--]--> Python 应用服务器 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_web/restful.md" class="nav-link sidebar-item" aria-label="Restful api"><!--[--><!--]--> Restful api <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_web/websafe.md" class="nav-link sidebar-item" aria-label="Web应用安全"><!--[--><!--]--> Web应用安全 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_web/web_nginx.md" class="nav-link sidebar-item" aria-label="Web服务器nginx"><!--[--><!--]--> Web服务器nginx <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_web/venv.md" class="nav-link sidebar-item" aria-label="包管理和虚拟环境"><!--[--><!--]--> 包管理和虚拟环境 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><h1 id="subprocess" tabindex="-1"><a class="header-anchor" href="#subprocess" aria-hidden="true">#</a> Subprocess</h1><blockquote><p>subprocess的目的就是启动一个新的进程并且与之通信。 subprocess模块中只定义了一个类: Popen。可以使用Popen来创建进程，并与进程进行复杂的交互。它的构造函数如下： The subprocess option:用来执行其他的可执行程序的，即执行外部命令。 他是os.fork() 和 os.execve() 的封装。 他启动的进程不会把父进程的模块加载一遍。使用subprocess的通信机制比较少，通过管道或者信号机制. The multiprocessing option:用来执行python的函数，他启动的进程会重新加载父进程的代码。可以通过Queue、Array、Value等对象来通信。</p></blockquote><ul><li>并发与并行 并发: 交错使用cpu实行任务，本质还是顺序执行 并行: 多核CPU同时执行，效率翻倍</li></ul><h2 id="用subprocess模块管理子进程" tabindex="-1"><a class="header-anchor" href="#用subprocess模块管理子进程" aria-hidden="true">#</a> 用subprocess模块管理子进程</h2><ol><li><p>Python启动的多个子进程是可以并行运行的。子进程将会独立于父进程而运行，这里的父进程指的Python解释器。</p><div class="language-Python ext-Python line-numbers-mode"><pre class="language-Python"><code>import subprocess
proc = subprocess.Popen([&#39;echo&#39;, &#39;Hello subprocess&#39;], stdout=subprocess.PIPE)
out, err = proc.communicate()
print(out.decode(&#39;utf-8&#39;))
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div></li><li><p>Python 子进程从父进程中解耦，父进程可以运行跟多条平行的子进程</p><div class="language-Python ext-Python line-numbers-mode"><pre class="language-Python"><code>import subprocess

def run_some():
    proc = subprocess.Popen([&#39;cmd&#39;],
                stdout=subprocess.PIPE,
                stdout=subprocess.PIPE)
    return proc

procs = []
for _ in range(10):
    proc = run_some(x)
    procs.append(proc)

for proc in procs:
    proc.communicate()  # 通过comunicate，等待这些子进程完成I/O工作并终结

# 如果不希望交互操作,使用shell执行
subpros = []
for _ in range(10):
    subpro = subprocess.Popen([&#39;cmd&#39;], shell=True)
    subpors.append(subpro)
for subpro in subpors:
    subpro.wait()
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div></li><li><p>Python向子进程输送数据</p><div class="language-Python ext-Python line-numbers-mode"><pre class="language-Python"><code>import os
def run_openssl(data):
    env = os.environ.copy()
    env[&#39;password&#39;] = b&#39;\xe24U&#39;
    proc = subprocess.Popen(
        [&#39;openssl&#39;, &#39;enc&#39;, &#39;-des3&#39;, &#39;-pass&#39;, &#39;env:password&#39;],
        env=env,
        stdin=subprocess.PIPE,
        stdout=subprocess.PIPE
    )
    proc.stdin.write(data)
    proc.stdin.flush() # 确保子进程获得输入
    return proc

procs = []
for _ in range(3):
    data = os.urandom(10)
    proc = run_openssl(data)
    procs.append(proc)
    other_proc = run_other(proc.stdout) # 将前一个进程的输出为输入
    other_procs.append(other_proc)

for proc in procs:
    out, error = proc.communicate()  # 通过comunicate，等待这些子进程完成I/O工作并终结
    print(out)
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div></li><li><p>Python子进程超时设置</p><div class="language-Python ext-Python line-numbers-mode"><pre class="language-Python"><code>for proc in procs:
    try:
        proc.communicate(timeout=0.1)  # 如果子进程在0.1s内没有结束，将抛出异常，可以强行终止
    except subprocess.TimeoutExpired:
        proc.terminate()
        proc.wait()
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div></li></ol><h2 id="popen详解" tabindex="-1"><a class="header-anchor" href="#popen详解" aria-hidden="true">#</a> Popen详解</h2><ol><li><p>初始化</p><div class="language-python ext-py line-numbers-mode"><pre class="language-python"><code>    subprocess<span class="token punctuation">.</span>Popen<span class="token punctuation">(</span>args<span class="token punctuation">,</span> bufsize<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> executable<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> stdin<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> stdout<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> stderr<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> preexec_fn<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> close_fds<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> shell<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> cwd<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> env<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> universal_newlines<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> startupinfo<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> creationflags<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token comment"># 参数args可以是字符串或者序列类型（如：list，元组），用于指定进程的可执行文件及其参数。如果是序列类型，第一个元素通常是可执行文件的路径。我们也可以显式的使用executeable参数来指定可执行文件的路径。</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li><li><p>参数</p><ol><li><p>参数stdin, stdout, stderr分别表示程序的标准输入、输出、错误句柄。他们可以是PIPE，文件描述符或文件对象，也可以设置为None，表示从父进程继承。</p></li><li><p>如果参数shell设为true，程序将通过shell来执行。</p></li><li><p>参数env是字典类型，用于指定子进程的环境变量。如果env = None，子进程的环境变量将从父进程中继承。</p></li><li><p>subprocess.PIPE</p><blockquote><p>在创建Popen对象时，subprocess.PIPE可以初始化stdin, stdout或stderr参数。表示与子进程通信的标准流。</p></blockquote></li><li><p>subprocess.STDOUT</p><blockquote><p>创建Popen对象时，用于初始化stderr参数，表示将错误通过标准输出流输出。</p></blockquote></li></ol></li><li><p>Popen的方法</p><ol><li><p>Popen.poll() 用于检查子进程是否已经结束。设置并返回returncode属性。</p></li><li><p>Popen.wait() 等待子进程结束。设置并返回returncode属性。</p></li><li><p>Popen.communicate(input=None) 与子进程进行交互。向stdin发送数据，或从stdout和stderr中读取数据。可选参数input指定发送到子进程的参数。Communicate()返回一个元组：(stdoutdata, stderrdata)。注意：如果希望通过进程的stdin向其发送数据，在创建Popen对象的时候，参数stdin必须被设置为PIPE。同样，如果希望从stdout和stderr获取数据，必须将stdout和stderr设置为PIPE。</p></li><li><p>Popen.send_signal(signal) 向子进程发送信号。</p></li><li><p>Popen.terminate() 停止(stop)子进程。在windows平台下，该方法将调用Windows API TerminateProcess（）来结束子进程。</p></li><li><p>Popen.kill() 杀死子进程。</p></li><li><p>Popen.stdin，Popen.stdout ，Popen.stderr ， 官方文档上这么说：</p><blockquote><p>stdin, stdout and stderr specify the executed programs’ standard input, standard output and standard error file handles, respectively. Valid values are PIPE, an existing file descriptor (a positive integer), an existing file object, and None.</p></blockquote></li><li><p>Popen.pid 获取子进程的进程ID。</p></li><li><p>Popen.returncode 获取进程的返回值。如果进程还没有结束，返回None。</p></li></ol></li><li><p>简单的用法</p><ol><li><p>执行</p><div class="language-python ext-py line-numbers-mode"><pre class="language-python"><code>p<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>Popen<span class="token punctuation">(</span><span class="token string">&quot;dir&quot;</span><span class="token punctuation">,</span> shell<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>  
p<span class="token punctuation">.</span>wait<span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token comment"># shell参数根据你要执行的命令的情况来决定，上面是dir命令，就一定要shell=True了，p.wait()可以得到命令的返回值。</span>
<span class="token comment"># 如果上面写成a=p.wait()，a就是returncode。那么输出a的话，有可能就是0【表示执行成功】。</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div></li><li><p>进程通讯</p><ol><li><p>如果想得到进程的输出，管道是个很方便的方法，这样：</p><div class="language-python ext-py line-numbers-mode"><pre class="language-python"><code>p<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>Popen<span class="token punctuation">(</span><span class="token string">&#39;ls&#39;</span><span class="token punctuation">,</span>shell<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>stdout<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>PIPE<span class="token punctuation">)</span>
stdoutput<span class="token punctuation">,</span>erroutput <span class="token operator">=</span> p<span class="token punctuation">.</span>communicate<span class="token punctuation">(</span><span class="token string">&#39;/home/zoer&#39;</span><span class="token punctuation">)</span>
<span class="token keyword">print</span> stdoutput<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
<span class="token keyword">print</span> erroutput
<span class="token comment"># 上面的例子通过communicate给stdin发送数据，然后使用一个tuple接收命令的执行结果。</span>

<span class="token comment"># 上面，标准输出和标准错误输出是分开的，也可以合并起来，只需要将stderr参数设置为subprocess.STDOUT就可以了，这样子：</span>
p<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>Popen<span class="token punctuation">(</span><span class="token string">&quot;dir&quot;</span><span class="token punctuation">,</span> shell<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> stdout<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>PIPE<span class="token punctuation">,</span> stderr<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>PIPE<span class="token punctuation">)</span>  
<span class="token punctuation">(</span>stdoutput<span class="token punctuation">,</span>erroutput<span class="token punctuation">)</span> <span class="token operator">=</span> p<span class="token punctuation">.</span>communicate<span class="token punctuation">(</span><span class="token punctuation">)</span>  
p<span class="token punctuation">.</span>communicate会一直等到进程退出，并将标准输出和标准错误输出返回，这样就可以得到子进程的输出了。

<span class="token comment"># 如果你想一行行处理子进程的输出，也没有问题：</span>
p<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>Popen<span class="token punctuation">(</span><span class="token string">&quot;dir&quot;</span><span class="token punctuation">,</span> shell<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> stdout<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>PIPE<span class="token punctuation">,</span> stderr<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>STDOUT<span class="token punctuation">)</span>  
<span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>  
    buff <span class="token operator">=</span> p<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>readline<span class="token punctuation">(</span><span class="token punctuation">)</span>  
    <span class="token keyword">if</span> buff <span class="token operator">==</span> <span class="token string">&#39;&#39;</span> <span class="token keyword">and</span> p<span class="token punctuation">.</span>poll<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token boolean">None</span><span class="token punctuation">:</span>  
        <span class="token keyword">break</span> 
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div></li></ol></li><li><p>死锁</p><div class="language-python ext-py line-numbers-mode"><pre class="language-python"><code><span class="token comment"># 但是如果你使用了管道，而又不去处理管道的输出，那么小心点，如果子进程输出数据过多，死锁就会发生了，比如下面的用法：</span>
p<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>Popen<span class="token punctuation">(</span><span class="token string">&quot;longprint&quot;</span><span class="token punctuation">,</span> shell<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> stdout<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>PIPE<span class="token punctuation">,</span> stderr<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>STDOUT<span class="token punctuation">)</span>  
p<span class="token punctuation">.</span>wait<span class="token punctuation">(</span><span class="token punctuation">)</span>  
longprint是一个假想的有大量输出的进程，那么在我的xp<span class="token punctuation">,</span> Python2<span class="token punctuation">.</span><span class="token number">5</span>的环境下，当输出达到<span class="token number">4096</span>时，死锁就发生了。当然，如果我们用p<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>readline或者p<span class="token punctuation">.</span>communicate去清理输出，那么无论输出多少，死锁都是不会发生的。或者我们不使用管道，比如不做重定向，或者重定向到文件，也都是可以避免死锁的。
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div></li><li><p>管道连接 subprocess还可以连接起来多个命令来执行。 在shell中我们知道，想要连接多个命令可以使用管道。 在subprocess中，可以使用上一个命令执行的输出结果作为下一次执行的输入。例子如下：</p><div class="language-python ext-py line-numbers-mode"><pre class="language-python"><code>p1<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>Popen<span class="token punctuation">(</span><span class="token string">&#39;cat ff&#39;</span><span class="token punctuation">,</span>shell<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>stdout<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>PIPE<span class="token punctuation">)</span>
p2<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>Popen<span class="token punctuation">(</span><span class="token string">&#39;tail -2&#39;</span><span class="token punctuation">,</span>shell<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>stdin<span class="token operator">=</span>p1<span class="token punctuation">.</span>stdout<span class="token punctuation">,</span>stdout<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>PIPE<span class="token punctuation">)</span>
<span class="token keyword">print</span> p2<span class="token punctuation">.</span>stdout
<span class="token keyword">print</span> p2<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># 例子中，p2使用了第一次执行命令的结果p1的stdout作为输入数据，然后执行tail命令。</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>下面是一个更大的例子。用来ping一系列的ip地址，并输出是否这些地址的主机是alive的。代码参考了python unix linux 系统管理指南。</p><div class="language-python ext-py line-numbers-mode"><pre class="language-python"><code>    <span class="token comment">#!/usr/bin/env python  </span>
    
    <span class="token keyword">from</span> threading <span class="token keyword">import</span> Thread  
    <span class="token keyword">import</span> subprocess  
    <span class="token keyword">from</span> Queue <span class="token keyword">import</span> Queue  
    
    num_threads<span class="token operator">=</span><span class="token number">3</span> 
    ips<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">&#39;127.0.0.1&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;116.56.148.187&#39;</span><span class="token punctuation">]</span>  
    q<span class="token operator">=</span>Queue<span class="token punctuation">(</span><span class="token punctuation">)</span>  
    <span class="token keyword">def</span> <span class="token function">pingme</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span>queue<span class="token punctuation">)</span><span class="token punctuation">:</span>  
        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>  
            ip<span class="token operator">=</span>queue<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span>  
            <span class="token keyword">print</span> <span class="token string">&#39;Thread %s pinging %s&#39;</span> <span class="token operator">%</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span>ip<span class="token punctuation">)</span>  
            ret<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>call<span class="token punctuation">(</span><span class="token string">&#39;ping -c 1 %s&#39;</span> <span class="token operator">%</span> ip<span class="token punctuation">,</span>shell<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>stdout<span class="token operator">=</span><span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">&#39;/dev/null&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;w&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>stderr<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>STDOUT<span class="token punctuation">)</span>  
            <span class="token keyword">if</span> ret<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">:</span>  
                <span class="token keyword">print</span> <span class="token string">&#39;%s is alive!&#39;</span> <span class="token operator">%</span>ip  
            <span class="token keyword">elif</span> ret<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">:</span>  
                <span class="token keyword">print</span> <span class="token string">&#39;%s is down...&#39;</span><span class="token operator">%</span>ip  
            queue<span class="token punctuation">.</span>task_done<span class="token punctuation">(</span><span class="token punctuation">)</span>  
    
    <span class="token comment">#start num_threads threads  </span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num_threads<span class="token punctuation">)</span><span class="token punctuation">:</span>  
        t<span class="token operator">=</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>pingme<span class="token punctuation">,</span>args<span class="token operator">=</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span>q<span class="token punctuation">)</span><span class="token punctuation">)</span>  
        t<span class="token punctuation">.</span>setDaemon<span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">)</span>  
        t<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>  
    
    <span class="token keyword">for</span> ip <span class="token keyword">in</span> ips<span class="token punctuation">:</span>  
        q<span class="token punctuation">.</span>put<span class="token punctuation">(</span>ip<span class="token punctuation">)</span>  
    <span class="token keyword">print</span> <span class="token string">&#39;main thread waiting...&#39;</span> 
    q<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">print</span> <span class="token string">&#39;Done&#39;</span> 
    在上面代码中使用subprocess的主要好处是，使用多个线程来执行ping命令会节省大量时间。

    假设说我们用一个线程来处理，那么每个 ping都要等待前一个结束之后再ping其他地址。那么如果有<span class="token number">100</span>个地址，一共需要的时间<span class="token operator">=</span><span class="token number">100</span><span class="token operator">*</span>平均时间。
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><p>如果使用多个线程，那么最长执行时间的线程就是整个程序运行的总时间。【时间比单个线程节省多了】</p></li></ol></li></ol><h2 id="这里要注意一下queue模块的学习" tabindex="-1"><a class="header-anchor" href="#这里要注意一下queue模块的学习" aria-hidden="true">#</a> 这里要注意一下Queue模块的学习</h2><p>pingme函数的执行是这样的：<br> 启动的线程会去执行pingme函数。<br> pingme函数会检测队列中是否有元素。如果有的话，则取出并执行ping命令。<br> 这个队列是多个线程共享的。所以这里我们不使用列表。【假设在这里我们使用列表，那么需要我们自己来进行同步控制。Queue本身已经通过信号量做了同步控制，节省了我们自己做同步控制的工作=。=】</p><p>代码中q的join函数是阻塞当前线程。下面是e文注释</p><blockquote><p>Queue.join()</p><p>Blocks until all items in the queue have been gotten and processed(task_done()). 学习Processing模块的时候，遇到了进程的join函数。进程的join函数意思说，等待进程运行结束。与这里的Queue的join有异曲同工之妙啊。processing模块学习的文章在这里。</p></blockquote><!--]--></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="meta-item-label">Last Updated: </span><span class="meta-item-info">9/17/2021, 6:55:21 PM</span></div><div class="meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: jizhuwo00@hotmail.com">maxiaoteng</span><!----><!--]--><!--]--></span></div></footer><!----><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script src="/assets/js/runtime~app.c5a372b8.js" defer></script><script src="/assets/js/8690.2c4ac00b.js" defer></script><script src="/assets/js/app.6ff1040a.js" defer></script>
  </body>
</html>
