<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.26">
    <title>Ajax | Xiaoteng Notebook</title><meta name="description" content="Just playing around">
    <link rel="preload" href="/assets/js/runtime~app.c5a372b8.js" as="script"><link rel="preload" href="/assets/css/styles.cdce1c03.css" as="style"><link rel="preload" href="/assets/js/8690.2c4ac00b.js" as="script"><link rel="preload" href="/assets/js/app.6ff1040a.js" as="script">
    <link rel="stylesheet" href="/assets/css/styles.cdce1c03.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/" class=""><img class="logo" src="/lion.jpeg" alt="Xiaoteng Notebook"><span class="site-name can-hide">Xiaoteng Notebook</span></a></span><div class="navbar-links-wrapper" style=""><!--[--><!--]--><nav class="navbar-links can-hide"><!--[--><div class="navbar-links-item"><a href="/" class="nav-link" aria-label="首页"><!--[--><!--]--> 首页 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/python/" class="nav-link router-link-active" aria-label="Python"><!--[--><!--]--> Python <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/vuepress/" class="nav-link" aria-label="Vuepress"><!--[--><!--]--> Vuepress <!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-dark-button" title="toggle dark mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-links"><!--[--><div class="navbar-links-item"><a href="/" class="nav-link" aria-label="首页"><!--[--><!--]--> 首页 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/python/" class="nav-link router-link-active" aria-label="Python"><!--[--><!--]--> Python <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/vuepress/" class="nav-link" aria-label="Vuepress"><!--[--><!--]--> Vuepress <!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-links"><!--[--><!--[--><a href="/python/" class="nav-link router-link-active sidebar-heading sidebar-item" aria-label="Python"><!--[--><!--]--> Python <!--[--><!--]--></a><!----><!--]--><!--[--><a href="/python/python_basics" class="nav-link sidebar-heading sidebar-item" aria-label="Python basic"><!--[--><!--]--> Python basic <!--[--><!--]--></a><ul class=""><li><!--[--><a href="/python/python_basics/decorators.md" class="nav-link sidebar-item" aria-label="Decorators 装饰器"><!--[--><!--]--> Decorators 装饰器 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_basics/metaclasses.md" class="nav-link sidebar-item" aria-label="Metaclasses"><!--[--><!--]--> Metaclasses <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_basics/slice.md" class="nav-link sidebar-item" aria-label="Slice 切片"><!--[--><!--]--> Slice 切片 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_basics/tips.md" class="nav-link sidebar-item" aria-label="Tips"><!--[--><!--]--> Tips <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_basics/unittest.md" class="nav-link sidebar-item" aria-label="Unittest"><!--[--><!--]--> Unittest <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_basics/built_in_module" class="nav-link sidebar-item" aria-label="内置模块"><!--[--><!--]--> 内置模块 <!--[--><!--]--></a><ul class="sidebar-sub-items"><li><!--[--><a href="/python/python_basics/built_in_module/base64.md" class="nav-link sidebar-item" aria-label="Base64"><!--[--><!--]--> Base64 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_basics/built_in_module/csv-model.md" class="nav-link sidebar-item" aria-label="Csv 模块"><!--[--><!--]--> Csv 模块 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_basics/built_in_module/datetime.md" class="nav-link sidebar-item" aria-label="Datetime time"><!--[--><!--]--> Datetime time <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_basics/built_in_module/html.md" class="nav-link sidebar-item" aria-label="Html 实体"><!--[--><!--]--> Html 实体 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_basics/built_in_module/json.md" class="nav-link sidebar-item" aria-label="Json格式"><!--[--><!--]--> Json格式 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_basics/built_in_module/multiprocessing.md" class="nav-link sidebar-item" aria-label="Multiprocessing"><!--[--><!--]--> Multiprocessing <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_basics/built_in_module/os-model.md" class="nav-link sidebar-item" aria-label="Os model"><!--[--><!--]--> Os model <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_basics/built_in_module/logging.md" class="nav-link sidebar-item" aria-label="Python logging"><!--[--><!--]--> Python logging <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_basics/built_in_module/random.md" class="nav-link sidebar-item" aria-label="Random"><!--[--><!--]--> Random <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_basics/built_in_module/string.md" class="nav-link sidebar-item" aria-label="String 模块"><!--[--><!--]--> String 模块 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_basics/built_in_module/subprocess.md" class="nav-link sidebar-item" aria-label="Subprocess"><!--[--><!--]--> Subprocess <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_basics/built_in_module/sys.md" class="nav-link sidebar-item" aria-label="Sys"><!--[--><!--]--> Sys <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_basics/built_in_module/time.md" class="nav-link sidebar-item" aria-label="Time 模块"><!--[--><!--]--> Time 模块 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_basics/built_in_module/urllib.md" class="nav-link sidebar-item" aria-label="Urllib"><!--[--><!--]--> Urllib <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_basics/built_in_module/re-model.md" class="nav-link sidebar-item" aria-label="正则表达式"><!--[--><!--]--> 正则表达式 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><a href="/python/python_basics/install.md" class="nav-link sidebar-item" aria-label="安装"><!--[--><!--]--> 安装 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_basics/exception.md" class="nav-link sidebar-item" aria-label="异常处理 exception"><!--[--><!--]--> 异常处理 exception <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_basics/data_structure.md" class="nav-link sidebar-item" aria-label="数据结构"><!--[--><!--]--> 数据结构 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_basics/modules" class="nav-link sidebar-item" aria-label="模块"><!--[--><!--]--> 模块 <!--[--><!--]--></a><ul class="sidebar-sub-items"><li><!--[--><a href="/python/python_basics/modules/apscheduler.md" class="nav-link sidebar-item" aria-label="Apscheduler"><!--[--><!--]--> Apscheduler <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_basics/modules/brotli.md" class="nav-link sidebar-item" aria-label="Brotli"><!--[--><!--]--> Brotli <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_basics/modules/httpx.md" class="nav-link sidebar-item" aria-label="Httpx"><!--[--><!--]--> Httpx <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_basics/modules/matplotlib.md" class="nav-link sidebar-item" aria-label="Matplotlib"><!--[--><!--]--> Matplotlib <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_basics/modules/paramiko.md" class="nav-link sidebar-item" aria-label="Paramiko 模块"><!--[--><!--]--> Paramiko 模块 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_basics/modules/pycryptodome.md" class="nav-link sidebar-item" aria-label="Pycryptodome 模块"><!--[--><!--]--> Pycryptodome 模块 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_basics/modules/pyexecjs.md" class="nav-link sidebar-item" aria-label="Pyexecjs python执行js代码"><!--[--><!--]--> Pyexecjs python执行js代码 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_basics/modules/pytesseract.md" class="nav-link sidebar-item" aria-label="Tesserocr ocr图片识别文字"><!--[--><!--]--> Tesserocr ocr图片识别文字 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_basics/modules/tesserocr.md" class="nav-link sidebar-item" aria-label="Tesserocr ocr图片识别文字"><!--[--><!--]--> Tesserocr ocr图片识别文字 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><a href="/python/python_basics/encode.md" class="nav-link sidebar-item" aria-label="编码问题"><!--[--><!--]--> 编码问题 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_basics/process_thread_coroutine.md" class="nav-link sidebar-item" aria-label="进程 线程 和 协程"><!--[--><!--]--> 进程 线程 和 协程 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_basics/iteration_generator_iterable.md" class="nav-link sidebar-item" aria-label="迭代器 生成器 可迭代对象"><!--[--><!--]--> 迭代器 生成器 可迭代对象 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--><!--[--><a href="/python/python_web" class="nav-link router-link-active sidebar-heading sidebar-item active" aria-label="Python web"><!--[--><!--]--> Python web <!--[--><!--]--></a><ul class=""><li><!--[--><a href="/python/python_web/ajax.md" class="nav-link sidebar-item active" aria-label="Ajax"><!--[--><!--]--> Ajax <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_web/celery" class="nav-link sidebar-item" aria-label="Celery"><!--[--><!--]--> Celery <!--[--><!--]--></a><ul class="sidebar-sub-items"><li><!--[--><a href="/python/python_web/celery/index.md" class="nav-link sidebar-item" aria-label="Celery"><!--[--><!--]--> Celery <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><a href="/python/python_web/django" class="nav-link sidebar-item" aria-label="Django"><!--[--><!--]--> Django <!--[--><!--]--></a><ul class="sidebar-sub-items"><li><!--[--><a href="/python/python_web/django/django_admin.md" class="nav-link sidebar-item" aria-label="Admin"><!--[--><!--]--> Admin <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_web/django/apps.md" class="nav-link sidebar-item" aria-label="Apps"><!--[--><!--]--> Apps <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_web/django/models.md" class="nav-link sidebar-item" aria-label="Models.py"><!--[--><!--]--> Models.py <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_web/django/more.md" class="nav-link sidebar-item" aria-label="More"><!--[--><!--]--> More <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_web/django/settings.md" class="nav-link sidebar-item" aria-label="Setting.py"><!--[--><!--]--> Setting.py <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_web/django/templates.md" class="nav-link sidebar-item" aria-label="Templates 模板"><!--[--><!--]--> Templates 模板 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_web/django/HTTP.md" class="nav-link sidebar-item" aria-label="Url"><!--[--><!--]--> Url <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_web/django/urls.md" class="nav-link sidebar-item" aria-label="Urls"><!--[--><!--]--> Urls <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_web/django/views.md" class="nav-link sidebar-item" aria-label="Views"><!--[--><!--]--> Views <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_web/django/django_start_up.md" class="nav-link sidebar-item" aria-label="开始一个项目"><!--[--><!--]--> 开始一个项目 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_web/django/static_files.md" class="nav-link sidebar-item" aria-label="静态文件"><!--[--><!--]--> 静态文件 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><a href="/python/python_web/flask" class="nav-link sidebar-item" aria-label="Flask"><!--[--><!--]--> Flask <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_web/http" class="nav-link sidebar-item" aria-label="Http 协议"><!--[--><!--]--> Http 协议 <!--[--><!--]--></a><ul class="sidebar-sub-items"><li><!--[--><a href="/python/python_web/http/post.md" class="nav-link sidebar-item" aria-label="Post"><!--[--><!--]--> Post <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><a href="/python/python_web/jinja.md" class="nav-link sidebar-item" aria-label="Jinja"><!--[--><!--]--> Jinja <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_web/python_wsgi.md" class="nav-link sidebar-item" aria-label="Python 应用服务器"><!--[--><!--]--> Python 应用服务器 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_web/restful.md" class="nav-link sidebar-item" aria-label="Restful api"><!--[--><!--]--> Restful api <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_web/websafe.md" class="nav-link sidebar-item" aria-label="Web应用安全"><!--[--><!--]--> Web应用安全 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_web/web_nginx.md" class="nav-link sidebar-item" aria-label="Web服务器nginx"><!--[--><!--]--> Web服务器nginx <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/python/python_web/venv.md" class="nav-link sidebar-item" aria-label="包管理和虚拟环境"><!--[--><!--]--> 包管理和虚拟环境 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><h1 id="ajax" tabindex="-1"><a class="header-anchor" href="#ajax" aria-hidden="true">#</a> Ajax</h1><p>Asynchronous JavaScript + XML</p><h2 id="http瓶颈" tabindex="-1"><a class="header-anchor" href="#http瓶颈" aria-hidden="true">#</a> HTTP瓶颈</h2><ol><li><p>表单提交<br> 一次操作渲染整个页面 有些操作将会增加带宽(点赞)<br> 有的操作会影响使用当前使用(视频网站的收藏\点赞等)</p></li><li><p>内容的实时更新<br> 通知/私信等提醒</p></li></ol><h2 id="ajax的实现" tabindex="-1"><a class="header-anchor" href="#ajax的实现" aria-hidden="true">#</a> Ajax的实现</h2><p><strong>只做局部更新</strong></p><p>一个demo</p><h3 id="ajax函数" tabindex="-1"><a class="header-anchor" href="#ajax函数" aria-hidden="true">#</a> ajax函数</h3><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>var log = function() {
    console.log.apply(console, arguments)
}

var e = function(sel) {
    return document.querySelector(sel)
}

/* 
 ajax 函数
*/
var ajax = function(method, path, data, responseCallback) {
    var r = new XMLHttpRequest()
    // 设置请求方法和请求地址
    r.open(method, path, true)
    // 设置发送的数据的格式为 application/json
    // 这个不是必须的
    r.setRequestHeader(&#39;Content-Type&#39;, &#39;application/json&#39;)
    // 注册响应函数
    r.onreadystatechange = function() {
        if(r.readyState === 4) {
            // r.response 存的就是服务器发过来的放在 HTTP BODY 中的数据
            responseCallback(r.response)
        }
    }
    // 把数据转换为 json 格式字符串
    data = JSON.stringify(data)
    // 发送请求
    r.send(data)
}

// TODO API
// 获取所有 todo
var apiTodoAll = function(callback) {
    var path = &#39;/api/todo/all&#39;
    ajax(&#39;GET&#39;, path, &#39;&#39;, callback)
}

// 增加一个 todo
var apiTodoAdd = function(form, callback) {
    var path = &#39;/api/todo/add&#39;
    ajax(&#39;POST&#39;, path, form, callback)
}

// 删除一个 todo
var apiTodoDelete = function(id, callback) {
    var path = &#39;/api/todo/delete?id=&#39; + id
    ajax(&#39;GET&#39;, path, &#39;&#39;, callback)
    //    get(path, callback)
}

// 更新一个 todo
var apiTodoUpdate = function(form, callback) {
    var path = &#39;/api/todo/update&#39;
    ajax(&#39;POST&#39;, path, form, callback)
    //    post(path, form, callback)
}

// load weibo all
var apiWeiboAll = function(callback) {
    var path = &#39;/weibo/all&#39;
    ajax(&#39;GET&#39;, path, &#39;&#39;, callback)
}

// 增加一个 微博
var apiWeiboAdd = function(form, callback) {
    var path = &#39;/weibo/add&#39;
    ajax(&#39;POST&#39;, path, form, callback)
}

// 删除一个微博
var apiWeiboDelete = function(weibo_id, callback) {
    var path = &#39;/weibo/delete?id=&#39;+weibo_id
    ajax(&#39;GET&#39;, path, &#39;&#39;, callback)
}

// 更新一个微博
var apiWeiboUpdate = function(form, callback) {
   var path = &#39;/weibo/update&#39;
   ajax(&#39;POST&#39;, path, form, callback)
}

// 增加一条微博评论
var apiCommentAdd = function(form, callback){
    var path = &#39;/weibo/commentAdd&#39;
    ajax(&#39;POST&#39;, path, form, callback)
}

// 删除一条微博评论
var apiCommentDelete = function(comment_id, callback){
    var path = &#39;/weibo/commentDelete?id=&#39;+comment_id
    ajax(&#39;GET&#39;, path, &#39;&#39;, callback)
}
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br></div></div><h3 id="具体操作dom" tabindex="-1"><a class="header-anchor" href="#具体操作dom" aria-hidden="true">#</a> 具体操作dom</h3><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>var timeString = function(timestamp) {
    t = new Date(timestamp * 1000)
    t = t.toLocaleString(&#39;ja-JP&#39;)
    return t
}

var commentsTemplate = function(comments) {
    var html = &#39;&#39;
    for(var i = 0; i &lt; comments.length; i++) {
        var c = comments[i]
        var t = `
            &lt;div class=&#39;comment-form&#39; id=&#39;comment-id-${c.id}&#39; data-id=${c.id}&gt;
                &lt;br&gt;
                [${c.username}]:${c.content}
                &lt;br&gt;
                &lt;span&gt;[创建时间]: ${timeString(c.ct)}&lt;/span&gt;
                &lt;button class=&#39;comment-delete&#39;&gt;删除评论&lt;/button&gt;
            &lt;/div&gt;
        `
        html += t
    }
    return html
}

var WeiboTemplate = function(Weibo) {
    var content = Weibo.content
    var id = Weibo.id
    var ct = Weibo.ct
    var visitor = Weibo.visitor
    var comments = commentsTemplate(Weibo.comments)
    var t = `
        &lt;div class=&#39;Weibo-cell&#39; id=&#39;Weibo-${id}&#39; data-id=${id}&gt;
            &lt;div class=&#39;Weibo-single&#39;&gt;
                [${visitor}]: &lt;span class=&#39;Weibo-content&#39;&gt;${content}&lt;/span&gt;
                &lt;br&gt;
                &lt;span&gt;[留言时间]: ${timeString(ct)}&lt;/span&gt;
                &lt;br&gt;&lt;br&gt;
            &lt;/div&gt;
            &lt;button class=&quot;Weibo-delete&quot;&gt;删除留言&lt;/button&gt;
            &lt;button class=&quot;Weibo-edit&quot;&gt;编辑留言&lt;/button&gt;
            &lt;div class=&quot;comment-list&quot;&gt;
                现有评论: ${comments}
            &lt;/div&gt;
            &lt;div class=&quot;comment-form&quot;&gt;
                &lt;input type=&quot;hidden&quot; name=&quot;weibo_id&quot; value=&quot;&quot;&gt;
                &lt;br&gt;
                评论内容:&lt;input class=&#39;comment-content&#39;name=&quot;content&quot;&gt;
                &lt;br&gt;&lt;br&gt;
                评论人(默认匿名):&lt;input class=&#39;comment-username&#39; name=&#39;username&#39;&gt;
                &lt;br&gt;&lt;br&gt;
                &lt;button class=&quot;comment-add&quot;&gt;添加评论&lt;/button&gt;
            &lt;/div&gt;
            &lt;p&gt;============================================================&lt;/p&gt;
        &lt;/div&gt;
    `
    return t
}

var insertWeibo = function(Weibo) {
    var WeiboCell = WeiboTemplate(Weibo)
    // log(&#39;单个微博html标签&#39;, WeiboCell)
    // 插入 Weibo-list
    var WeiboList = e(&#39;.Weibo-list&#39;)
    WeiboList.insertAdjacentHTML(&#39;beforeend&#39;, WeiboCell)
}

var insertEditForm = function(cell, content) {
    var form = `
        &lt;div class=&#39;Weibo-edit-form&#39;&gt;
            &lt;input class=&quot;Weibo-edit-input&quot;&gt;
            // &lt;button class=&#39;Weibo-update&#39;&gt;更新&lt;/button&gt;
        &lt;/div&gt;
    `
    cell.insertAdjacentHTML(&#39;afterBegin&#39;, form)
    var input = e(&#39;.Weibo-edit-input&#39;)
    input.value = content
}

var loadWeibos = function() {
        // 调用 ajax api 来载入数据
    apiWeiboAll(function(r) {
        // console.log(&#39;load all&#39;, r)
        // 解析为 数组
        var Weibos = JSON.parse(r)
        // 循环添加到页面中
        for(var i = 0; i &lt; Weibos.length; i++) {
            var Weibo = Weibos[i]
            insertWeibo(Weibo)
        }
    })
}

var bindEventWeiboAdd = function() {
    var b = e(&#39;#id-button-add-weibo&#39;)
    // 注意, 第二个参数可以直接给出定义函数
    b.addEventListener(&#39;click&#39;, function(){
        var input1 = e(&#39;#id-input-weibo&#39;)
        var content = input1.value
        var input2 = e(&#39;#id-visitor-weibo&#39;)
        var visitor = input2.value
        log(&#39;click add&#39;, content, visitor)
        var form = {
            &#39;content&#39;: content,
            &#39;visitor&#39;: visitor,
        }
        input1.value = &#39;&#39;
        input2.value = &#39;&#39;
        if(content.length&gt;2){
            apiWeiboAdd(form, function(r) {
                // 收到返回的数据, 插入到页面中
                var Weibo = JSON.parse(r)
                insertWeibo(Weibo)
            })
        }
        else{
            alert(&quot;留言内容太少了吧!&quot;)
        }
    })
}

var bindEventWeiboDelete = function() {
    var WeiboList = e(&#39;.Weibo-list&#39;)
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener(&#39;click&#39;, function(event){
        var self = event.target
        if(self.classList.contains(&#39;Weibo-delete&#39;)){
            // 删除这个 Weibo
            var WeiboCell = self.parentElement
            var Weibo_id = WeiboCell.dataset.id
            log(&#39;点击到了删除按钮, 微博id是:&#39;, Weibo_id)
            apiWeiboDelete(Weibo_id, function(r){
                log(&#39;删除成功&#39;, Weibo_id)
                var return_wb = JSON.parse(r)
                if(return_wb.id==Weibo_id){
                    WeiboCell.remove()
                }
            })
        }
    })
}

var bindEventWeiboEdit = function() {
    var WeiboList = e(&#39;.Weibo-list&#39;)
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener(&#39;click&#39;, function(event){
        var self = event.target
        if(self.classList.contains(&#39;Weibo-edit&#39;)){
            // 删除这个 Weibo
            var WeiboCell = self.parentElement
            // 从微博cell中选出展示微博内容的那部分,缩小了查找范围
            var weibo_content = WeiboCell.querySelector(&#39;.Weibo-content&#39;)
            var content = weibo_content.innerHTML
            // 将原来的展示内容改为修改框
            weibo_content.parentElement.style.display=&quot;none&quot;
            // 插入更新框
            insertEditForm(WeiboCell, content)
        }
    })
}

var bindEventWeiboUpdate = function() {
    var WeiboList = e(&#39;.Weibo-list&#39;)
    // 注意, 第二个参数可以直接给出定义函数
    WeiboList.addEventListener(&#39;click&#39;, function(event){
        var self = event.target
        if(self.classList.contains(&#39;Weibo-update&#39;)){
            log(&#39;点击了 update &#39;)
            //
            var editForm = self.parentElement
            // querySelector 是 DOM 元素的方法
            // document.querySelector 中的 document 是所有元素的祖先元素
            var input = editForm.querySelector(&#39;.Weibo-edit-input&#39;)
            var content = input.value
            // 用 closest 方法可以找到最近的直系父节点
            var WeiboCell = self.closest(&#39;.Weibo-cell&#39;)
            var Weibo_id = WeiboCell.dataset.id
            var form = {
                &#39;id&#39;: Weibo_id,
                &#39;content&#39;: content,
            }
            apiWeiboUpdate(form, function(r){
                log(&#39;更新成功&#39;, Weibo_id)
                var Weibo = JSON.parse(r)
                log(Weibo)
                var selector = &#39;#Weibo-&#39; + Weibo.id
                var WeiboCell = e(selector)
                var contentSpan = WeiboCell.querySelector(&#39;.Weibo-content&#39;)
                contentSpan.innerHTML = Weibo.content
                // 显示微博内容框
                contentSpan.parentElement.style.display=&quot;&quot;
                // 将编辑框删除
                var edit_form = WeiboCell.querySelector(&quot;.Weibo-edit-form&quot;)
                edit_form.remove()
                //  WeiboCell.remove()
            })
        }
    })
}


// 插入评论函数
var insertCommentCell = function(comment){
    var comments = [comment]
    var commentCell = commentsTemplate(comments)
    var weibo_id = comment.weibo_id
    var weiboCell = e(&#39;#Weibo-&#39; + weibo_id)
    // log(&#39;weiboCell:&#39;, weiboCell)
    var commentsList = weiboCell.querySelector(&#39;.comment-list&#39;)
    commentsList.insertAdjacentHTML(&#39;beforeend&#39;, commentCell)
}


// 绑定添加评论事件
var bindEventCommentAdd = function(){
    var WeiboList = e(&#39;.Weibo-list&#39;)
    WeiboList.addEventListener(&#39;click&#39;, function(event){
        var self = event.target
        if(self.classList.contains(&quot;comment-add&quot;)){
            // log(&#39;点击到了评论按钮&#39;, self)
            var comment_form = self.parentElement
            var input1 = comment_form.querySelector(&#39;.comment-content&#39;)
            var comment_content = input1.value
            var input2 = comment_form.querySelector(&#39;.comment-username&#39;)
            var comment_username= input2.value
            var WeiboCell = comment_form.parentElement
            var Weibo_id = WeiboCell.dataset.id
            // log(&#39;当前微博的id&#39;, Weibo_id)
            var form = {
              &#39;weibo_id&#39;: Weibo_id,
              &#39;content&#39;: comment_content,
              &#39;username&#39;: comment_username,
            }
            input1.value = &#39;&#39;
            input2.value = &#39;&#39;
            if(comment_content.length&gt;0){
                apiCommentAdd(form, function(r){
                    // 收到响应, 先log出来
                    var new_comment = JSON.parse(r)
                    // log(&#39;评论已添加&#39;, new_comment)
                    insertCommentCell(new_comment)
                })
            }else{
                alert(&#39;评论内容不可为空&#39;)
            }
        }
    })
}


// 绑定删除评论事件
var bindEventCommentDelete = function(){
    var WeiboList = e(&#39;.Weibo-list&#39;)
    WeiboList.addEventListener(&#39;click&#39;, function(event){
        var self = event.target
        if(self.classList.contains(&quot;comment-delete&quot;)){
            log(&#39;点击到了删除评论按钮&#39;, self)
            var comment_form = self.parentElement
            comment_id = comment_form.dataset.id
            log(&#39;报告,当前要删除的评论id&#39;, comment_id)
            apiCommentDelete(comment_id, function(r){
                var delete_comment = JSON.parse(r)
                comment_form = e(&#39;#comment-id-&#39;+comment_id)
                // log(&#39;报告,我要移除的评论标签:&#39;, comment_form)
                comment_form.remove()
            })
        }
    })
}


var bindEvents = function() {
    bindEventWeiboAdd()
    bindEventWeiboDelete()
//    bindEventWeiboEdit()
//    bindEventWeiboUpdate()
    bindEventCommentAdd()
//    bindEventCommentDelete()
}


var __main = function() {
    bindEvents()
    loadWeibos()
}

__main()

</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br><span class="line-number">215</span><br><span class="line-number">216</span><br><span class="line-number">217</span><br><span class="line-number">218</span><br><span class="line-number">219</span><br><span class="line-number">220</span><br><span class="line-number">221</span><br><span class="line-number">222</span><br><span class="line-number">223</span><br><span class="line-number">224</span><br><span class="line-number">225</span><br><span class="line-number">226</span><br><span class="line-number">227</span><br><span class="line-number">228</span><br><span class="line-number">229</span><br><span class="line-number">230</span><br><span class="line-number">231</span><br><span class="line-number">232</span><br><span class="line-number">233</span><br><span class="line-number">234</span><br><span class="line-number">235</span><br><span class="line-number">236</span><br><span class="line-number">237</span><br><span class="line-number">238</span><br><span class="line-number">239</span><br><span class="line-number">240</span><br><span class="line-number">241</span><br><span class="line-number">242</span><br><span class="line-number">243</span><br><span class="line-number">244</span><br><span class="line-number">245</span><br><span class="line-number">246</span><br><span class="line-number">247</span><br><span class="line-number">248</span><br><span class="line-number">249</span><br><span class="line-number">250</span><br><span class="line-number">251</span><br><span class="line-number">252</span><br><span class="line-number">253</span><br><span class="line-number">254</span><br><span class="line-number">255</span><br><span class="line-number">256</span><br><span class="line-number">257</span><br><span class="line-number">258</span><br><span class="line-number">259</span><br><span class="line-number">260</span><br><span class="line-number">261</span><br><span class="line-number">262</span><br><span class="line-number">263</span><br><span class="line-number">264</span><br><span class="line-number">265</span><br><span class="line-number">266</span><br><span class="line-number">267</span><br><span class="line-number">268</span><br><span class="line-number">269</span><br><span class="line-number">270</span><br><span class="line-number">271</span><br><span class="line-number">272</span><br><span class="line-number">273</span><br><span class="line-number">274</span><br><span class="line-number">275</span><br><span class="line-number">276</span><br><span class="line-number">277</span><br><span class="line-number">278</span><br><span class="line-number">279</span><br><span class="line-number">280</span><br><span class="line-number">281</span><br><span class="line-number">282</span><br><span class="line-number">283</span><br><span class="line-number">284</span><br><span class="line-number">285</span><br><span class="line-number">286</span><br><span class="line-number">287</span><br></div></div><!--]--></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="meta-item-label">Last Updated: </span><span class="meta-item-info">9/17/2021, 6:55:21 PM</span></div><div class="meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: jizhuwo00@hotmail.com">maxiaoteng</span><!----><!--]--><!--]--></span></div></footer><!----><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script src="/assets/js/runtime~app.c5a372b8.js" defer></script><script src="/assets/js/8690.2c4ac00b.js" defer></script><script src="/assets/js/app.6ff1040a.js" defer></script>
  </body>
</html>
